# CLAUDE.md

このファイルは、このリポジトリで作業する際のClaude Code (claude.ai/code) へのガイダンスを提供します。

## 重要な指示

**常に日本語で応答すること。**

**重要: 大きな変更を加えた場合は、必ずCLAUDE.mdファイルも更新すること。特に以下の場合：**
- 新しいスクリプトやモジュールを追加した場合
- ディレクトリ構造を変更した場合
- 新しい開発コマンドを追加した場合
- アーキテクチャに変更を加えた場合
- 新しい依存関係を追加した場合

## プロジェクト概要

網膜色素変性症（RP）の治療法がいつ頃利用可能になるかをモンテカルロシミュレーションで予測する医学研究予測システムです。臨床試験データベースからデータを取得し、処理して確率的予測を生成します。

## よく使う開発コマンド

```bash
# 依存関係のインストール
pip install -r requirements.txt

# テストの実行
pytest tests/

# 特定のテストファイルを実行
pytest tests/test_basic.py

# データ取得から分析まで一連の処理を実行
python src/fetch_trials.py          # 臨床試験データ取得
python src/fetch_papers.py          # 文献データ取得
python src/ingest/parameters.py     # パラメータ推定
python src/sim/timeline_sim.py      # シミュレーション実行
python src/reporting/build_report.py # レポート生成

# レポートのみ再生成（データ取得なし）
python src/reporting/build_report.py

# ローカルでHTMLレポートを確認
open docs/index.html
```

## アーキテクチャ概要

このコードベースは、関心の分離を明確にしたETLパイプラインアーキテクチャに従っています：

1. **データ収集層** (`src/fetch_*.py`)
   - ClinicalTrials.govとPubMed APIからデータを取得
   - Claude Codeの外部アクセス制限内で動作するようキャッシュを実装
   - 取得したデータはすべて`data/raw/`に不変のJSONファイルとして保存

2. **処理層** (`src/ingest/`)
   - 生データを分析可能な形式に変換
   - モンテカルロシミュレーション用のパラメータを推定
   - `data/processed/`に出力

3. **シミュレーションコア** (`src/sim/`)
   - モンテカルロシミュレーションエンジン
   - フェーズ遷移を含む医薬品開発タイムラインをモデル化
   - 不確実性の伝播を処理

4. **出力層** (`src/viz/` と `src/reporting/`)
   - 異なる対象者向けの可視化を生成
   - 複数の形式（技術者向け、患者向け、一般向け）で自動レポートを作成

## 実装上の重要な考慮事項

1. **外部APIアクセス**: Claude Codeの限定的な外部アクセスで動作するよう設計：
   - すべてのAPIレスポンスを`data/raw/`にローカルキャッシュ
   - 再ダウンロードを避けるため増分取得を使用
   - オフライン分析用に処理済みデータを保存

2. **Pythonバージョン**: SYSTEM.mdで指定されているPython 3.11を使用

3. **データの不変性**: `data/raw/`内のファイルは決して変更しない - これにより再現性を確保

4. **モンテカルロパラメータ**: 主要なシミュレーションパラメータは設定ファイルに保存し、バージョン管理する

5. **テスト戦略**: すべてのデータ処理とシミュレーションロジックには対応するテストが必要

## プロジェクト固有のコンテキスト

- 主な対象者：研究者、RP患者、一般市民
- 再現性と透明性を重視
- 結果はGitHub Pages経由で公開
- すべての可視化でアクセシビリティを考慮（色覚異常対応のパレット）
- レポートは異なる対象者向けに複数の形式で生成

## 開発ワークフロー

1. すべての変更は`develop`ブランチで作業
2. 実装順序はTASK_LIST.jsonのタスクリストに従う
3. すべてのデータ変換をコード化（手動ステップなし）
4. 外部依存関係やAPIキーが必要な場合は文書化
5. 変更をコミットする前にテストを実行

## 重要なファイル

- `TASK_LIST.json`: 詳細な実装ロードマップ（完了済み）
- `README.md`: 包括的なプロジェクト仕様と方法論
- `SYSTEM.md`: Claude Code操作手順
- `docs/index.html`: 自動生成されるレポート（ブラウザで閲覧）
- `docs/reality_and_actions.md`: 予測の現実性と一般人向けアクションガイド（NEW）
- `docs/reality_and_actions.html`: アクションガイドのHTML版（NEW）
- `docs/bottlenecks.md`: 開発ボトルネック分析と支援策
- `.github/workflows/ci.yml`: GitHub Actions CI/CD設定

## 完了したタスク（2025年6月25日時点）

1. ✅ 初期ディレクトリ構造の構築
2. ✅ 臨床試験データ取得機能（ClinicalTrials.gov API v2対応）
3. ✅ PubMed文献データ取得機能
4. ✅ 治験パラメータ推定（成功率・期間）
5. ✅ モンテカルロシミュレーション（10,000回/プログラム）
6. ✅ 感度分析とトルネード図生成
7. ✅ 自動レポート生成（Markdown/HTML）
8. ✅ 開発ボトルネック分析ドキュメント
9. ✅ GitHub Actions CI/CDパイプライン

## 主な分析結果

- **最速承認予測**: 
  - **MCO-010（Nanoscope社）**: 2025-2026年（2025年初頭FDA申請予定、Fast Track指定）
  - **OCU400（Ocugen社）**: 2026-2027年（2024年Phase 3開始、1年間の試験期間でFDAと合意）
  - Janssen社遺伝子治療: 2028年
  - BIIB111（NightstaRx/Biogen）: 2029年
- **全体中央値**: 2036年
- **Phase別成功率**: Phase 1: 86.2%, Phase 2: 78.4%, Phase 3: 71.4%（※限定的データに基づく）
- **アクティブな試験数**: 54件（2025年6月時点）

## 最近の更新履歴

### 2025年6月26日（第3回更新）
- サイト構成の大幅な見直し
  - 事実（現状）とAI予測を明確に分離
  - `current_status_facts.md` - 確認可能な事実のみ
  - `ai_predictions.md` - AI予測と不確実性を明記
  - 全ページにナビゲーションメニューを追加
- 公開に向けた準備
  - `publication_disclaimer.md` - 包括的な免責事項
  - `publication_checklist.md` - 公開前チェックリスト
  - 医学的助言ではないことを全ページで強調
- HTMLナビゲーションの改善
  - 全8ページ相互リンク実装
  - アクセシビリティ対応維持
  - OGPタグを全ページに追加

### 2025年6月26日（第2回更新）
- **gemini-searchを使用した最新情報の反映**
  - MCO-010: RESTORE試験で統計的有意性達成、2025年Q1にBLA申請予定を確認
  - OCU400: 2年データで100%改善/維持、2026年BLA/MAA申請予定
  - Janssen社 Botaretigene: Phase 3で主要評価項目未達成（2025年5月発表）
  - Biogen BIIB112: 開発中断を確認
- シミュレーションパラメータの更新
  - Janssen社試験の成功率20%に低下
  - MCO-010、OCU400に「high confidence」フラグ追加
- OGPタグをHTML生成コードに追加（SNSシェア対応）

### 2025年6月26日（第1回更新）
- **最新の臨床試験情報を反映した大規模アップデート**
  - MCO-010（Nanoscope社）が2025年初頭にFDA申請、最速2025-2026年承認見込み
  - OCU400（Ocugen社）が2024年Phase 3開始、2026-2027年承認見込み
  - シミュレーションコードに特別処理を追加（Fast Track指定の反映）
- 「現実的なアクション」ドキュメントを最新情報で更新
  - 承認時期予測を2025-2026年に前倒し
  - 変異非依存型治療の進展を強調

### 2025年6月25日
- 「現実的なアクション」ドキュメント（docs/reality_and_actions.md）を大幅改訂
  - 具体的な手順、URL、費用、検索キーワードを追加
  - 各アクションを実行可能なステップに分解
  - 実際の病院名、サービス名を明記
- ChatGPT o3の検証結果に基づいて修正
  - 遺伝子検査費用を10-12万円に更新（パネル検査）
  - タイムラインを2029年以降に調整（より現実的に）
  - 神戸アイセンター病院を追加
- 遺伝子検査費用の負担軽減方法を追加
  - 保険適用、研究参加、段階的アプローチなど5つの方法
  - 予算別の現実的な選択肢を提示
  - 無料検査可能な研究機関をリストアップ
- モンテカルロシミュレーションの改善
  - Phase 3期間を3-5年から4-7年に修正（遺伝子治療に適合）
  - 長期実施中試験の処理ロジックを改善
  - 遺伝子治療固有のリスクを反映